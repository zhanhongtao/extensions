<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8" />
</head>
<body>
<embed id="picdownloader" type="application/sogou-npruntime-picdownloader-plugin" />
<script>
var downloader = document.getElementById("picdownloader");

function download(url, path, callback) {
  if (typeof callback !== 'function') callback = function() {};
  downloader.download(url, path, function() {
    callback(null, url);
  });
}

var queue = function queue( list, fn, callback, index, ret ) {
  index = index || 0;
  ret = ret || [];
  var next = function ( value, stop, returnCurrentValue ) {
    ret[ ret.length ] = value;
    if ( stop ) {
      return callback.apply( null, returnCurrentValue ? [value] : ret );
    }
    queue( list, fn, callback, ++index, ret );
  };
  if ( index < list.length ) {
    var argus = [ list[ index ], index, ret ];
    if ( fn.length ) {
      argus = argus.slice( 0, fn.length - 1 );
    }
    argus.push( next );
    fn.apply( null, argus );
  } else if ( callback ) {
    callback.apply( null, [index] );
  }
};

// @TODO: 支持设定下载目录
var path = 'D:\\download\\';
var match = 'http://ac.qq.com/';
var cache = {
  // tabid: {isauto: true}
};

function todo(dir, list, done) {
  queue(list, function(src, index, next) {
    save = path + dir + '\\' + index + '.jpg';
    download(src, save, function() {
      next();
    });
  }, function() {
    done();
  });
}

// 侧边栏按钮只针对当前标签页有效.
sogouExplorer.sidebarAction.onClicked.addListener(function() {
  sogouExplorer.tabs.getSelected(function(tab) {
    var url = tab.url;
    var tid = tab.id;
    if (url.indexOf(match) == 0) {
      var config = cache[tid] = cache[tid] || {isauto: false};
      if (config.isauto) {
        config.isauto = !config.isauto;
      } else {
        sogouExplorer.tabs.sendRequest(tid, {
          cmd: 'do'
        });
      }
    } else {
      sogouExplorer.tabs.create({
        'active': true,
        'selected': true,
        'coreType': 'Webkit',
        'url': match
      });
    }
  });
});

// 关闭标签/窗口时
sogouExplorer.tabs.onRemoved.addListener(function(tid) {
  if (cache[tid]) {
    delete cache[tid];
  }
});

// 标签页被更新时
sogouExplorer.tabs.onUpdated.addListener(function(tid, info, tab) {
  var url = tab.url;
  if (url.indexOf(match) != 0) {
    if (cache[tid]) {
      delete cache[tid];
    }
  } else {
    // @TODO:
    // 在自动操作的标签页, 更新到其它漫画 - 需要停止下载.
  }
});

// 事件侦听器
sogouExplorer.extension.onRequest.addListener(function(request, sender, response) {
  var cmd = request.cmd;
  var tab = sender.tab;
  var tid = tab.id;
  var config = cache[tid] = cache[tid] || {isauto: false};
  switch(cmd) {
    // 开始下载
    case 'download':
      todo(request.dir, request.src, function() {
        var _cmd = config.isauto ? 'next' : 'confirm';
        sogouExplorer.tabs.sendRequest(tid, {
          cmd: _cmd
        });
      });
      break;
    // 设置自动项
    case 'setauto':
      config.isauto = request.data;
      sogouExplorer.tabs.sendRequest(tid, {
        cmd: 'next'
      });
      break;
    // 判定是否自动加载
    case 'isauto':
      if (config.isauto) {
        sogouExplorer.tabs.sendRequest(tid, {cmd: 'do'});
      }
      break;
    default:
      break;
  }
});
</script>
</body>
</html>